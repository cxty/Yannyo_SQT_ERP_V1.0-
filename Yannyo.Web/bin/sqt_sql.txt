select p.StorageID,isnull(ss.Quantity,0) Quantity,p.ProductsID,p.pBarcode,p.pName,p.pUnits,p.pMaxUnits,p.pToBoxNo from (select * from tbProductsInfo,tbStorageInfo where tbProductsInfo.pState=0 and tbStorageInfo.sState=0 ) as p left join (select so.StorageID,so.ProductsID,sum(case when so.oType in(1,4) then isnull(so.pQuantity,0) else -isnull(so.pQuantity,0) end) as Quantity from ( select dl.StorageID,dl.ProductsID,dl.pQuantity,o.OrderID,o.oOrderNum,o.oType,o.oAppendTime,o.oOrderDateTime,o.oState,o.oSteps from ( select 	l.OrderID,	d.StorageID,	d.ProductsID,	d.pQuantity from tbStorageProductLogDataInfo as d left join tbStorageProductLogInfo as l on d.StorageProductLogID=l.StorageProductLogID 	where (l.splAppendTime < @bDate) 	group by d.StorageID,d.ProductsID,d.pQuantity,l.OrderID ) as dl left join tbOrderInfo as o on dl.OrderID=o.OrderID ) as so group by so.StorageID,so.ProductsID ) as ss on p.ProductsID=ss.ProductsID and p.StorageID=ss.StorageID  where 1=1 ; select p.StaffID, p.splRemake, p.splAppendTime, p.OrderListID, p.StorageID, p.ProductsID, (case when o.oType in(1,4) then isnull(p.pQuantity,0) else -isnull(p.pQuantity,0) end) Quantity, o.OrderID, o.oOrderNum, o.oType, o.oAppendTime, o.oOrderDateTime, o.oState, o.oSteps, o.StoresID, o.oCustomersName from ( 	select l.StaffID, 	l.OrderID, 	l.splRemake, 	l.splAppendTime, 	d.OrderListID, 	d.StorageID, 	d.ProductsID, 	d.pQuantity 	from tbStorageProductLogDataInfo as d left join tbStorageProductLogInfo as l on d.StorageProductLogID=l.StorageProductLogID 	where (l.splAppendTime between @bDate and @eDate) 	) as p left join tbOrderInfo as o on p.OrderID=o.OrderID  where 1=1  ; select * from tbProductsInfo where pState=0; select * from tbStorageInfo where sState=0; 
